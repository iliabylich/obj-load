name: release

on:
  push:
    branches: [ master ]

defaults:
  run:
    shell: bash

jobs:
  release-server:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: install rust
        uses: dtolnay/rust-toolchain@stable
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: install cargo-deb
        run: cargo install cargo-deb

      - name: build
        run: cargo deb --deb-revision="$(date +%s)" -p obj-down-up-load-server

      - name: give binary a representative name
        run: cp target/release/obj-down-up-load-server server-x86_64-unknown-linux-gnu

      - name: release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifactErrorsFailBuild: true
          removeArtifacts: true
          tag: latest
          artifacts: server-x86_64-unknown-linux-gnu,target/debian/*.deb
          token: ${{ secrets.GITHUB_TOKEN }}

  release-client:
    runs-on: ${{ matrix.build.os }}
    strategy:
      fail-fast: false
      matrix:
        build:
          - { os: ubuntu-latest, target: x86_64-unknown-linux-gnu }
          - { os: macos-latest,  target: x86_64-apple-darwin      }
          - { os: macos-latest,  target: aarch64-apple-darwin     }
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: install rust
        uses: dtolnay/rust-toolchain@stable
        with:
          profile: minimal
          toolchain: stable
          override: true
          targets: ${{ matrix.build.target }}

      - name: compile
        run: cargo build --release -p obj-download -p obj-upload --target ${{ matrix.build.target }}

      - name: give executables representable name
        run: |
          cp target/${{ matrix.build.target }}/release/obj-download ./obj-download-${{ matrix.build.target }}
          cp target/${{ matrix.build.target }}/release/obj-upload ./obj-upload-${{ matrix.build.target }}

      - name: release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifactErrorsFailBuild: true
          tag: latest-client
          artifacts: obj-download-${{ matrix.build.target }},obj-upload-${{ matrix.build.target }}
          token: ${{ secrets.GITHUB_TOKEN }}
